# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

version: "3"

dotenv:
  - ../../env-testing
  - env

includes:
  aw: ./TaskfileAWS.yml
  az: ./TaskfileAzure.yml
  gc: ./TaskfileGCloud.yml

tasks:
  setup: { silent: true }

  status:
    - nuv config use
    - nuv debug info

  kind:create:
    - which docker
    - nuv setup docker create

  kind:delete:
    - nuv setup docker delete

  k3s:create:
    cmds:
    - task: aw:vm:create
      vars:
          NAME: k3s-test
          TYPE: k3s

  mk8s:create:
    cmds:
    - task: aw:vm:create
      vars:
          NAME: mk8s-test
          TYPE: mk8s

  k3s:delete:
    cmds:
    - task: aw:vm:delete
      vars:
          NAME: k3s-test
          TYPE: k3s

  mk8s:delete:
    cmds:
    - task: aw:vm:delete
      vars:
          NAME: mk8s-test
          TYPE: mk8s

  osh:create:
    - mkdir -p conf/osh
    - cp conf/openshift-install-config.yaml conf/osh/install-config.yaml
    - openshift-install create cluster --dir conf/osh

  osh:delete:
    - openshift-install destroy cluster --dir conf/osh

  progress:
    desc: update the progress
    cmds:
      - |
        if test -z "{{.N}}"
        then echo use task progress N=value
        else 
        X=$(((100*{{.N}})/96))
        echo $X
        curl -L "https://geps.dev/progress/$X?dangerColor=006600&warningColor=006600&successColor=006600" >img/progress.svg
        fi

  all:
    desc: run all the tests (same as all.sh)
    silent: true
    cmds:
      - |
        {{if eq OS "dawin"}} 
          ./all.sh {{.TYPE}}
        {{else if eq OS "linux"}}
          ./all.sh {{.TYPE}}
        {{else}}
          cmd.exe /c "windows\all.cmd" {{.TYPE}}
        {{end}}
