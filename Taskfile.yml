# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

version: "3"

vars:
  CLOUD: gcp

dotenv:
  - ../../env-testing
  - env

includes:
  aws: ./TaskfileAWS.yml
  gcp: ./TaskfileGCloud.yml
  azure: ./TaskfileAzure.yml

tasks:
  setup: { silent: true }

  status:
    - nuv config use
    - nuv debug info

  kind:create:
    - which docker
    - nuv setup docker create

  kind:delete:
    - nuv setup docker delete

  k3s:create:
    cmds:
    - task: "{{.CLOUD}}:vm:create"
      vars:
          NAME: k3s-test
          TYPE: k3s

  mk8s:create:
    cmds:
    - task: "{{.CLOUD}}:vm:create"
      vars:
          NAME: mk8s-test
          TYPE: mk8s

  k3s:delete:
    cmds:
    - task: "{{.CLOUD}}:vm:delete"
      vars:
          NAME: k3s-test
          TYPE: k3s

  mk8s:delete:
    cmds:
    - task: "{{.CLOUD}}:vm:delete"
      vars:
          NAME: mk8s-test
          TYPE: mk8s

  osh:create:
    cmds:
    - mkdir -p conf/{{.CLOUD}}
    - cp conf/{{.CLOUD}}-install-config.yaml conf/{{.CLOUD}}/install-config.yaml
    - openshift-install create cluster --dir conf/{{.CLOUD}}

  osh:delete:
    - openshift-install destroy cluster --dir conf/{{.CLOUD}}

  progress:
    desc: update the progress
    cmds:
      - |
        if test -z "{{.N}}"
        then echo use task progress N=value
        else 
        X=$(((100*{{.N}})/103))
        echo $X
        curl -L "https://geps.dev/progress/$X?dangerColor=006600&warningColor=006600&successColor=006600" >img/progress.svg
        fi

  all:
    desc: run all the tests (same as all.sh)
    silent: true
    cmds:
      - |
        {{if eq OS "windows"}} 
          cmd.exe /c "tests\all.cmd" {{.TYPE}}
        {{else}}
          cd tests
          ./all.sh {{.TYPE}}
          cd ..
        {{end}}
